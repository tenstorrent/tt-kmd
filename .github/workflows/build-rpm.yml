name: Build RPM Package

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      ref:
        description: 'Git ref to build from'
        default: ${{ github.ref }}
        required: true
        type: string

jobs:
  build-rpm:
    name: Build RPM Package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-tags: true
          fetch-depth: 0

      - name: Install rpmbuild
        run: sudo apt-get update && sudo apt-get install -y rpm

      - name: Build package
        run: ./tools/build_rpms.sh

      - name: Determine version for artifact naming
        id: version
        run: |
          VERSION=$(./tools/current-version)
          # Convert to RPM version format (- becomes ~)
          RPM_VERSION="${VERSION//-/\~}"
          echo "version=${RPM_VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${RPM_VERSION}"

      - name: Upload RPM package
        uses: actions/upload-artifact@v4
        with:
          name: tenstorrent-dkms-${{ steps.version.outputs.version }}-1.noarch.rpm
          path: tenstorrent-dkms-${{ steps.version.outputs.version }}-1.noarch.rpm

      - name: Display package info
        run: |
          echo "=== Package Information ==="
          rpm -qip tenstorrent-dkms-${{ steps.version.outputs.version }}-1.noarch.rpm
